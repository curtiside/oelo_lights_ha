# Base on Home Assistant container to get all HA dependencies
FROM ghcr.io/home-assistant/home-assistant:stable

# Install test dependencies (Alpine Linux uses apk)
# Add gcompat and glib for better Chrome compatibility in Alpine
RUN apk add --no-cache \
    docker \
    docker-compose \
    curl \
    chromium \
    chromium-chromedriver \
    py3-pip \
    bash \
    xvfb \
    ttf-freefont \
    font-noto \
    udev \
    gcompat \
    glib \
    nss \
    libxcb \
    libgcc

# Install additional Python packages for testing
RUN pip3 install --no-cache-dir selenium aiohttp requests websockets

# Create symlink for chromedriver if needed
RUN ln -sf /usr/bin/chromium-chromedriver /usr/bin/chromedriver 2>/dev/null || true

# Set up display for headless Chrome
ENV DISPLAY=:99
ENV CHROME_BIN=/usr/bin/chromium
ENV CHROMEDRIVER_PATH=/usr/bin/chromium-chromedriver

# Fix DBus issues that cause ChromeDriver to hang in containers
ENV DBUS_SESSION_BUS_ADDRESS=/dev/null

# Copy custom_components into container (same as HA container)
COPY custom_components /config/custom_components

WORKDIR /workspace

CMD ["python3", "/tests/test_user_workflow.py"]
